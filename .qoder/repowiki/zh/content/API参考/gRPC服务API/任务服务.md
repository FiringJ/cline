# 任务服务

<cite>
**本文档引用的文件**   
- [task.proto](file://proto/cline/task.proto#L1-L116)
- [TaskState.ts](file://src/core/task/TaskState.ts#L1-L65)
- [newTask.ts](file://src/core/controller/task/newTask.ts#L1-L15)
- [clearTask.ts](file://src/core/controller/task/clearTask.ts#L1-L14)
- [taskFeedback.ts](file://src/core/controller/task/taskFeedback.ts#L1-L27)
- [taskCompletionViewChanges.ts](file://src/core/controller/task/taskCompletionViewChanges.ts#L1-L20)
</cite>

## 目录
1. [简介](#简介)
2. [RPC方法接口](#rpc方法接口)
3. [核心消息类型](#核心消息类型)
4. [任务生命周期](#任务生命周期)
5. [调用示例](#调用示例)
6. [任务队列与资源管理](#任务队列与资源管理)

## 简介
任务服务（TaskService）是cline系统的核心组件，负责管理用户任务的创建、执行、状态跟踪和历史记录。该服务通过gRPC接口暴露功能，支持任务的全生命周期管理，包括创建、取消、清除、反馈收集和历史查询。任务服务与系统其他组件（如检查点管理、工具执行、状态跟踪）紧密集成，确保任务执行的可靠性和可追溯性。

## RPC方法接口

### 取消当前任务
```protobuf
rpc cancelTask(EmptyRequest) returns (Empty);
```
终止当前正在运行的任务。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L10-L11)

### 清除当前任务
```protobuf
rpc clearTask(EmptyRequest) returns (Empty);
```
清除当前任务的状态和上下文。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L12-L13)
- [clearTask.ts](file://src/core/controller/task/clearTask.ts#L1-L14)

### 获取任务总大小
```protobuf
rpc getTotalTasksSize(EmptyRequest) returns (Int64);
```
返回所有任务的总大小（以字节为单位）。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L14-L15)

### 删除多个任务
```protobuf
rpc deleteTasksWithIds(StringArrayRequest) returns (Empty);
```
根据提供的ID列表删除多个任务。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L16-L17)

### 创建新任务
```protobuf
rpc newTask(NewTaskRequest) returns (Empty);
```
使用提供的文本和可选的图像/文件创建新任务。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L18-L19)
- [newTask.ts](file://src/core/controller/task/newTask.ts#L1-L15)

### 显示指定ID的任务
```protobuf
rpc showTaskWithId(StringRequest) returns (TaskResponse);
```
根据任务ID检索任务详情。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L20-L21)

### 导出任务为Markdown
```protobuf
rpc exportTaskWithId(StringRequest) returns (Empty);
```
将指定ID的任务导出为Markdown格式。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L22-L23)

### 切换任务收藏状态
```protobuf
rpc toggleTaskFavorite(TaskFavoriteRequest) returns (Empty);
```
切换任务的收藏状态（收藏/取消收藏）。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L24-L25)

### 获取任务历史
```protobuf
rpc getTaskHistory(GetTaskHistoryRequest) returns (TaskHistoryArray);
```
根据过滤条件获取任务历史记录。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L26-L27)

### 发送询问响应
```protobuf
rpc askResponse(AskResponseRequest) returns (Empty);
```
对之前的询问操作发送响应。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L28-L29)

### 记录任务反馈
```protobuf
rpc taskFeedback(StringRequest) returns (Empty);
```
记录用户对任务的反馈（点赞/点踩）。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L30-L31)
- [taskFeedback.ts](file://src/core/controller/task/taskFeedback.ts#L1-L27)

### 显示任务完成变更
```protobuf
rpc taskCompletionViewChanges(Int64Request) returns (Empty);
```
在视图中显示任务完成时的变更差异。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L32-L33)
- [taskCompletionViewChanges.ts](file://src/core/controller/task/taskCompletionViewChanges.ts#L1-L20)

### 执行快速任务
```protobuf
rpc executeQuickWin(ExecuteQuickWinRequest) returns (Empty);
```
执行一个快速任务，包含命令和标题。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L34-L35)

### 删除所有任务历史
```protobuf
rpc deleteAllTaskHistory(EmptyRequest) returns (DeleteAllTaskHistoryCount);
```
删除所有任务历史记录，并返回已删除的任务数量。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L36-L37)

## 核心消息类型

### 新任务请求 (NewTaskRequest)
```protobuf
message NewTaskRequest {
  Metadata metadata = 1;
  string text = 2;
  repeated string images = 3;
  repeated string files = 4;
}
```
- **metadata**: 请求元数据
- **text**: 任务文本内容
- **images**: 附加的图像文件路径列表
- **files**: 附加的文件路径列表

**Section sources**
- [task.proto](file://proto/cline/task.proto#L39-L43)

### 任务收藏请求 (TaskFavoriteRequest)
```protobuf
message TaskFavoriteRequest {
  Metadata metadata = 1;
  string task_id = 2;
  bool is_favorited = 3;
}
```
- **metadata**: 请求元数据
- **task_id**: 目标任务的ID
- **is_favorited**: 新的收藏状态（true为收藏，false为取消收藏）

**Section sources**
- [task.proto](file://proto/cline/task.proto#L45-L49)

### 任务响应 (TaskResponse)
```protobuf
message TaskResponse {
  string id = 1;
  string task = 2;
  int64 ts = 3;
  bool is_favorited = 4;
  int64 size = 5;
  double total_cost = 6;
  int32 tokens_in = 7;
  int32 tokens_out = 8;
  int32 cache_writes = 9;
  int32 cache_reads = 10;
}
```
- **id**: 任务唯一标识符
- **task**: 任务描述文本
- **ts**: 任务创建时间戳
- **is_favorited**: 是否被收藏
- **size**: 任务大小（字节）
- **total_cost**: 任务总成本
- **tokens_in**: 输入token数量
- **tokens_out**: 输出token数量
- **cache_writes**: 缓存写入次数
- **cache_reads**: 缓存读取次数

**Section sources**
- [task.proto](file://proto/cline/task.proto#L51-L62)

### 获取任务历史请求 (GetTaskHistoryRequest)
```protobuf
message GetTaskHistoryRequest {
  Metadata metadata = 1;
  bool favorites_only = 2;
  string search_query = 3;
  string sort_by = 4;
  bool current_workspace_only = 5;
}
```
- **metadata**: 请求元数据
- **favorites_only**: 是否仅返回收藏的任务
- **search_query**: 搜索查询字符串
- **sort_by**: 排序字段
- **current_workspace_only**: 是否仅返回当前工作区的任务

**Section sources**
- [task.proto](file://proto/cline/task.proto#L64-L69)

### 任务历史数组 (TaskHistoryArray)
```protobuf
message TaskHistoryArray {
  repeated TaskItem tasks = 1;
  int32 total_count = 2;
}
```
- **tasks**: 任务项列表
- **total_count**: 总任务数量

**Section sources**
- [task.proto](file://proto/cline/task.proto#L71-L75)

### 任务项 (TaskItem)
```protobuf
message TaskItem {
  string id = 1;
  string task = 2;
  int64 ts = 3;
  bool is_favorited = 4;
  int64 size = 5;
  double total_cost = 6;
  int32 tokens_in = 7;
  int32 tokens_out = 8;
  int32 cache_writes = 9;
  int32 cache_reads = 10;
}
```
包含与TaskResponse相同的核心任务信息字段。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L77-L88)

### 询问响应请求 (AskResponseRequest)
```protobuf
message AskResponseRequest {
  Metadata metadata = 1;
  string response_type = 2; 
  string text = 3;
  repeated string images = 4;
  repeated string files = 5;
}
```
- **metadata**: 请求元数据
- **response_type**: 响应类型
- **text**: 响应文本
- **images**: 附加的图像
- **files**: 附加的文件

**Section sources**
- [task.proto](file://proto/cline/task.proto#L90-L95)

### 执行快速任务请求 (ExecuteQuickWinRequest)
```protobuf
message ExecuteQuickWinRequest {
  Metadata metadata = 1;
  string command = 2;
  string title = 3;
}
```
- **metadata**: 请求元数据
- **command**: 要执行的命令
- **title**: 任务标题

**Section sources**
- [task.proto](file://proto/cline/task.proto#L97-L101)

### 删除所有任务历史计数 (DeleteAllTaskHistoryCount)
```protobuf
message DeleteAllTaskHistoryCount {
  int32 tasks_deleted = 1;
}
```
- **tasks_deleted**: 已删除的任务数量

**Section sources**
- [task.proto](file://proto/cline/task.proto#L103-L106)

## 任务生命周期

### 任务状态管理
任务的内部状态由`TaskState`类管理，包含以下关键状态属性：

```typescript
export class TaskState {
	// 流式传输标志
	isStreaming = false
	isWaitingForFirstChunk = false
	didCompleteReadingStream = false

	// 内容处理
	assistantMessageContent: AssistantMessageContent[] = []
	userMessageContent: (Anthropic.TextBlockParam | Anthropic.ImageBlockParam)[] = []
	userMessageContentReady = false

	// 询问/响应处理
	askResponse?: ClineAskResponse
	askResponseText?: string
	askResponseImages?: string[]
	askResponseFiles?: string[]
	lastMessageTs?: number

	// 工具执行标志
	didRejectTool = false
	didAlreadyUseTool = false
	didEditFile: boolean = false

	// 任务中止/取消
	abort: boolean = false
	didFinishAbortingStream = false
	abandoned = false

	// 初始化状态
	isInitialized = false
}
```

### 生命周期阶段
1. **初始化阶段**: 当调用`newTask`时，创建`TaskState`实例并初始化状态
2. **执行阶段**: `isStreaming`为true，系统开始流式处理模型响应
3. **交互阶段**: 如果需要用户输入，`askResponse`被设置，等待用户响应
4. **完成阶段**: `didCompleteReadingStream`为true，任务完成
5. **中止阶段**: 如果`abort`为true，任务被取消

**Section sources**
- [TaskState.ts](file://src/core/task/TaskState.ts#L1-L65)

## 调用示例

### 完整任务流程
以下示例展示了从用户输入到任务完成的完整流程：

1. **创建任务**: 用户通过UI输入任务指令，触发`newTask`调用
   ```protobuf
   newTask({
     text: "重构用户认证模块，提高代码可读性",
     images: [],
     files: ["src/auth/auth.service.ts"]
   })
   ```

2. **任务执行**: 系统创建任务并开始执行，`TaskState`进入流式处理模式
   - `isStreaming = true`
   - `isInitialized = true`

3. **模型交互**: 模型分析任务并生成执行计划
   - 系统流式接收模型响应
   - `assistantMessageContent`逐步填充

4. **工具使用**: 模型决定使用代码编辑工具
   - `didEditFile = true`
   - 系统应用代码变更

5. **任务完成**: 模型返回完成结果
   - `didCompleteReadingStream = true`
   - 系统生成任务完成消息

6. **用户反馈**: 用户对结果进行评价
   ```protobuf
   taskFeedback({
     value: "thumbs_up"
   })
   ```

7. **历史记录**: 任务详情被保存到历史记录中
   - 包含token使用、成本、时间戳等信息

**Section sources**
- [newTask.ts](file://src/core/controller/task/newTask.ts#L1-L15)
- [TaskState.ts](file://src/core/task/TaskState.ts#L1-L65)
- [taskFeedback.ts](file://src/core/controller/task/taskFeedback.ts#L1-L27)

## 任务队列与资源管理

### 任务队列管理
- **单任务模式**: 系统一次只处理一个任务，新任务会中断当前任务
- **历史记录**: 所有完成的任务被保存在历史记录中，可通过`getTaskHistory`查询
- **过滤与排序**: 支持按收藏状态、搜索关键词、工作区等条件过滤任务

### 超时处理
- **流式超时**: 如果流式响应长时间无数据，系统会自动中止任务
- **工具执行超时**: 每个工具执行都有预设的超时限制
- **整体任务超时**: 长时间运行的任务会被监控并可能被中止

### 资源隔离策略
- **状态隔离**: 每个任务有独立的`TaskState`实例，确保状态不互相影响
- **上下文隔离**: 任务的上下文信息（如文件、消息历史）被隔离管理
- **缓存管理**: 使用`cache_reads`和`cache_writes`指标跟踪缓存使用情况，优化资源利用
- **错误隔离**: 任务执行中的错误被限制在当前任务范围内，不会影响其他任务

**Section sources**
- [task.proto](file://proto/cline/task.proto#L1-L116)
- [TaskState.ts](file://src/core/task/TaskState.ts#L1-L65)