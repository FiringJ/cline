# 高级功能配置

<cite>
**本文档中引用的文件**  
- [updateAutoApprovalSettings.ts](file://src/core/controller/state/updateAutoApprovalSettings.ts)
- [togglePlanActModeProto.ts](file://src/core/controller/state/togglePlanActModeProto.ts)
- [updateApiConfigurationProto.ts](file://src/core/controller/models/updateApiConfigurationProto.ts)
- [refreshOpenRouterModels.ts](file://src/core/controller/models/refreshOpenRouterModels.ts)
- [updateSettings.ts](file://src/core/controller/state/updateSettings.ts)
</cite>

## 目录
1. [自动审批设置管理](#自动审批设置管理)
2. [计划/执行模式切换机制](#计划执行模式切换机制)
3. [API配置更新与模型同步](#api配置更新与模型同步)
4. [其他高级设置项](#其他高级设置项)

## 自动审批设置管理

`updateAutoApprovalSettings` 函数用于管理自动审批规则，允许用户配置不同操作类型的审批策略。该函数首先检查传入的设置版本是否高于当前版本，以确保配置更新的有序性。若版本有效，则通过 `convertProtoToAutoApprovalSettings` 将协议缓冲区（proto）格式的请求转换为应用内部使用的 `AutoApprovalSettings` 对象，并将其持久化存储于全局状态中。

当存在活跃任务时，系统会同步更新任务实例中的自动审批设置，确保新策略立即生效。特别地，若最大请求数（`maxRequests`）发生变化，系统将重置连续自动批准请求计数器，防止因配置变更导致的计数逻辑错误。

此机制支持的操作类型包括：读取文件、外部读取文件、编辑文件、外部编辑文件、执行安全命令、执行所有命令等。通过精细控制各项操作的自动批准开关，用户可在自动化效率与安全性之间取得平衡。

**Section sources**
- [updateAutoApprovalSettings.ts](file://src/core/controller/state/updateAutoApprovalSettings.ts#L11-L30)
- [task/index.ts](file://src/core/task/index.ts#L470-L482)

## 计划/执行模式切换机制

`togglePlanActModeProto` 实现了计划（Plan）与执行（Act）模式之间的切换功能。该函数接收一个包含目标模式的请求对象，将其从协议缓冲区枚举值转换为内部使用的字符串模式（"plan" 或 "act"），并调用控制器的 `togglePlanActMode` 方法完成实际的模式切换。

切换过程中可附带聊天内容（`chatContent`），以便在切换至新模式时自动发送指定消息。函数返回一个布尔值响应，指示消息是否成功发送。该机制通过统一的协议接口实现了模式切换的远程调用能力，支持前端界面与后端逻辑的解耦。

模式切换直接影响任务流程的决策与执行阶段：在“计划”模式下，系统侧重于生成详细的任务分解与执行策略；而在“执行”模式下，则专注于按既定方案实施具体操作。这种分离有助于提高复杂任务的可管理性与透明度。

**Section sources**
- [togglePlanActModeProto.ts](file://src/core/controller/state/togglePlanActModeProto.ts#L11-L33)

## API配置更新与模型同步

### API配置更新

`updateApiConfigurationProto` 函数负责更新AI模型提供商的API配置。它接收一个包含新配置的请求，首先验证配置的有效性，然后通过 `convertProtoToApiConfiguration` 转换为内部格式，并使用 `stateManager.setApiConfiguration` 将其持久化。

若当前存在活跃任务，系统会重建API处理器（`buildApiHandler`），并将新配置注入其中，确保后续API调用使用最新设置。最后，通过 `postStateToWebview` 通知前端界面更新状态，保持UI与后端配置的一致性。

### 模型列表同步

`refreshOpenRouterModels` 函数用于从OpenRouter API同步最新的模型列表。该函数发起HTTP请求获取模型数据，解析并转换为内部模型信息结构，同时对特定模型（如Claude系列）进行价格、上下文窗口等参数的定制化调整。

同步过程中，系统会为支持百万上下文的模型（如claude-sonnet-4）生成专用变体（`:1m`），并添加硬编码的内部模型（`cline/sonic`）。获取的模型列表将被缓存至本地文件系统，以备网络请求失败时回退使用。前端通过调用 `refreshOpenRouterModels` 方法触发此同步过程，确保用户界面展示的模型信息始终为最新。

**Section sources**
- [updateApiConfigurationProto.ts](file://src/core/controller/models/updateApiConfigurationProto.ts#L12-L42)
- [refreshOpenRouterModels.ts](file://src/core/controller/models/refreshOpenRouterModels.ts#L75-L255)
- [ExtensionStateContext.tsx](file://webview-ui/src/context/ExtensionStateContext.tsx#L610-L620)

## 其他高级设置项

`updateSettings` 函数提供了一个统一的接口，用于批量更新多种高级设置项。其主要功能包括：

- **遥测设置**：控制是否启用遥测数据收集。
- **检查点设置**：启用或禁用任务检查点功能。
- **MCP市场设置**：控制MCP（Model Control Protocol）市场功能的启用状态。
- **终端设置**：配置终端集成超时时间、重用策略及输出行数限制。
- **浏览器设置**：更新浏览器视口尺寸、远程浏览器配置及自定义启动参数。
- **任务模式设置**：调整OpenAI推理努力程度、严格计划模式、YOLO模式等行为参数。
- **终端配置**：设置默认终端配置文件，并在切换时自动关闭不匹配的终端实例，同时提示用户处理繁忙终端。

该函数采用合并更新策略，对于复杂对象（如浏览器设置），会保留未在请求中明确指定的字段，确保配置的完整性。所有更新最终通过 `postStateToWebview` 同步至前端，实现配置的即时生效。

**Section sources**
- [updateSettings.ts](file://src/core/controller/state/updateSettings.ts#L25-L283)